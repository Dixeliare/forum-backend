CREATE TABLE IF NOT EXISTS "USERS" (
	"internal_id" BIGINT NOT NULL UNIQUE,
	"public_id" VARCHAR(255) NOT NULL,
	"last_public_id_changed_at" TIMESTAMPTZ,
	"is_searchable_by_public_id" BOOLEAN,
	"display_name" VARCHAR(255),
	"email" VARCHAR(255) NOT NULL,
	"password_hash" VARCHAR(255) NOT NULL,
	"bio" TEXT,
	"avatar_url" VARCHAR(255),
	"banner_id" VARCHAR(255),
	"created_at" TIMESTAMPTZ NOT NULL,
	"updated_at" TIMESTAMPTZ,
	"account_status" VARCHAR(255) NOT NULL,
	"is_verified" BOOLEAN,
	"deleted_at" TIMESTAMPTZ,
	"deletion_reason" VARCHAR(255),
	"timezone" VARCHAR(255) NOT NULL,
	"display_nsfw" BOOLEAN,
	PRIMARY KEY("internal_id")
);


CREATE INDEX "USERS_index_0"
ON "USERS" ();
CREATE INDEX "USERS_index_1"
ON "USERS" ();
CREATE INDEX "USERS_index_2"
ON "USERS" ();

CREATE TABLE IF NOT EXISTS "COMMUNITIES" (
	"internal_id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"slug" VARCHAR(255) NOT NULL,
	"public_id" BIGINT NOT NULL,
	"display_name" TEXT NOT NULL,
	"description" TEXT,
	"avatar_url" VARCHAR(255),
	"cover_url" VARCHAR(255),
	"is_nsfw" BOOLEAN NOT NULL,
	"is_private" BOOLEAN NOT NULL,
	"is_searchable" BOOLEAN NOT NULL,
	"member_count" BIGINT NOT NULL,
	"post_count" BIGINT NOT NULL,
	"created_at" TIMESTAMPTZ NOT NULL,
	"updated_at" TIMESTAMPTZ NOT NULL,
	"updated_user_id" BIGINT,
	PRIMARY KEY("internal_id")
);




CREATE TABLE IF NOT EXISTS "USER_FOLLOWS" (
	"follower_id (internal_id)" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"target_id (public_id)" BIGINT NOT NULL,
	"created_at" TIMESTAMPTZ NOT NULL,
	"status" BOOLEAN NOT NULL,
	"request_at" TIMESTAMPTZ NOT NULL,
	"accepted_at" TIMESTAMPTZ NOT NULL,
	"rejected_at" TIMESTAMPTZ NOT NULL,
	PRIMARY KEY("follower_id (internal_id)", "target_id (public_id)", "status")
);




CREATE TABLE IF NOT EXISTS "COMMUNITY_MEMBERS" (
	"community_id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"user_id" BIGINT NOT NULL,
	"role_id" SMALLINT NOT NULL,
	"joined_at" TIMESTAMPTZ NOT NULL,
	"status" VARCHAR(255)
);




CREATE TABLE IF NOT EXISTS "ROLES" (
	"role_id" SMALLINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"role_name" TEXT NOT NULL,
	PRIMARY KEY("role_id")
);




CREATE TABLE IF NOT EXISTS "POSTS" (
	"id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"community_id" BIGINT,
	"author_id" BIGINT NOT NULL,
	"title" VARCHAR(255),
	"content" TEXT NOT NULL,
	"topic_id" BIGINT,
	"public_id" BIGINT NOT NULL,
	"slug" VARCHAR(255) NOT NULL,
	"is_nsfw" BOOLEAN NOT NULL,
	"likes_count" INTEGER,
	"comments_count" INTEGER,
	"shares_count" INTEGER,
	"saves_count" INTEGER,
	"tags_count" INTEGER,
	"caption_expands_count" INTEGER,
	"media_clicks" INTEGER,
	"dwell_7s_count" INTEGER,
	"viral_score" DECIMAL,
	"created_at" TIMESTAMPTZ,
	"updated_at" TIMESTAMPTZ,
	PRIMARY KEY("id")
);




CREATE TABLE IF NOT EXISTS "MEDIA" (
	"id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"post_id" BIGINT NOT NULL,
	"comment_id" BIGINT,
	"type" TEXT NOT NULL,
	"media_url" VARCHAR(255),
	"thumbnail_url" VARCHAR(255),
	"position" SMALLINT NOT NULL,
	"width" INTEGER NOT NULL,
	"height" INTEGER NOT NULL,
	"duration" INTERVAL NOT NULL,
	"created_at" TIMESTAMPTZ,
	PRIMARY KEY("id")
);




CREATE TABLE IF NOT EXISTS "COMMENTS" (
	"id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"post_id" BIGINT,
	"thread_id" BIGINT,
	"author_id" BIGINT NOT NULL,
	"parent_comment_id" BIGINT,
	"content" TEXT NOT NULL,
	"likes_count" INTEGER NOT NULL,
	"created_at" TIMESTAMPTZ NOT NULL,
	"updated_at" TIMESTAMPTZ,
	PRIMARY KEY("id")
);




CREATE TABLE IF NOT EXISTS "FORUMS" (
	"id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"name" VARCHAR(255) NOT NULL,
	"slug" VARCHAR(255) NOT NULL,
	"public_id" BIGINT NOT NULL,
	"description" TEXT,
	"owner_id" BIGINT NOT NULL,
	"is_discoverable" BOOLEAN,
	"is_private" BOOLEAN NOT NULL,
	"is_nsfw" BOOLEAN NOT NULL,
	"member_count" INTEGER NOT NULL,
	"categories_count" SMALLINT,
	"threads_count" INTEGER NOT NULL,
	"created_at" TIMESTAMPTZ NOT NULL,
	"updated_at" TIMESTAMPTZ NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE IF NOT EXISTS "CATEGORIES" (
	"internal_id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"display_name" VARCHAR(255) NOT NULL,
	"slug" VARCHAR(255) NOT NULL,
	"display_order" SMALLINT NOT NULL,
	"description" TEXT,
	"created_at" TIMESTAMPTZ NOT NULL,
	"forum_id" BIGINT NOT NULL,
	"updated_at" TIMESTAMPTZ,
	PRIMARY KEY("internal_id")
);




CREATE TABLE IF NOT EXISTS "SUB-FORUMS" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"display_name" VARCHAR(255) NOT NULL,
	"slug" VARCHAR(255) NOT NULL,
	"category_id" BIGINT NOT NULL,
	"description" TEXT,
	"last_activity_at" TIMESTAMPTZ NOT NULL,
	"last_thread_id" BIGINT,
	"last_comment_id" BIGINT NOT NULL,
	"last_activity_by_user_id" BIGINT NOT NULL,
	"created_at" TIMESTAMPTZ NOT NULL,
	"updated_at" TIMESTAMPTZ,
	PRIMARY KEY("id")
);




CREATE TABLE IF NOT EXISTS "THREADS" (
	"internal_id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"title" TEXT,
	"content" TEXT NOT NULL,
	"public_id" BIGINT NOT NULL,
	"slug" BIGINT NOT NULL,
	"view_count" INTEGER NOT NULL,
	"last_activity_at" TIMESTAMPTZ NOT NULL,
	"sub_forum_id" BIGINT NOT NULL,
	"author_id" BIGINT NOT NULL,
	"created_at" TIMESTAMPTZ NOT NULL,
	"updated_at" TIMESTAMPTZ,
	PRIMARY KEY("internal_id")
);




CREATE TABLE IF NOT EXISTS "COMMENT_LIKES" (
	"id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"user_id" BIGINT,
	"comment_id" BIGINT,
	"created_at" TIMESTAMPTZ,
	PRIMARY KEY("id")
);




CREATE TABLE IF NOT EXISTS "TOPICS" (
	"internal_id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"name" VARCHAR(255) NOT NULL,
	"slug" VARCHAR(255) NOT NULL,
	"description" TEXT,
	"post_count" BIGINT NOT NULL,
	"created_at" TIMESTAMPTZ NOT NULL,
	"updated_at" TIMESTAMPTZ,
	PRIMARY KEY("internal_id")
);



ALTER TABLE "USERS"
ADD FOREIGN KEY("internal_id") REFERENCES "USER_FOLLOWS"("follower_id (internal_id)")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "USERS"
ADD FOREIGN KEY("internal_id") REFERENCES "USER_FOLLOWS"("target_id (public_id)")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "USERS"
ADD FOREIGN KEY("internal_id") REFERENCES "COMMUNITY_MEMBERS"("user_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "COMMUNITIES"
ADD FOREIGN KEY("internal_id") REFERENCES "COMMUNITY_MEMBERS"("community_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "ROLES"
ADD FOREIGN KEY("role_id") REFERENCES "COMMUNITY_MEMBERS"("role_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "COMMUNITIES"
ADD FOREIGN KEY("internal_id") REFERENCES "POSTS"("community_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "USERS"
ADD FOREIGN KEY("internal_id") REFERENCES "POSTS"("author_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "POSTS"
ADD FOREIGN KEY("id") REFERENCES "MEDIA"("post_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "COMMENTS"
ADD FOREIGN KEY("id") REFERENCES "MEDIA"("comment_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "POSTS"
ADD FOREIGN KEY("id") REFERENCES "COMMENTS"("post_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "COMMENTS"
ADD FOREIGN KEY("id") REFERENCES "COMMENT_LIKES"("comment_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "USERS"
ADD FOREIGN KEY("internal_id") REFERENCES "COMMENTS"("author_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "USERS"
ADD FOREIGN KEY("internal_id") REFERENCES "COMMENT_LIKES"("user_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "FORUMS"
ADD FOREIGN KEY("id") REFERENCES "CATEGORIES"("forum_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "CATEGORIES"
ADD FOREIGN KEY("internal_id") REFERENCES "SUB-FORUMS"("category_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "SUB-FORUMS"
ADD FOREIGN KEY("id") REFERENCES "THREADS"("sub_forum_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "SUB-FORUMS"
ADD FOREIGN KEY("last_thread_id") REFERENCES "THREADS"("internal_id")
ON UPDATE CASCADE ON DELETE NO ACTION;
ALTER TABLE "THREADS"
ADD FOREIGN KEY("internal_id") REFERENCES "COMMENTS"("thread_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "USERS"
ADD FOREIGN KEY("internal_id") REFERENCES "FORUMS"("owner_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "POSTS"
ADD FOREIGN KEY("topic_id") REFERENCES "TOPICS"("internal_id")
ON UPDATE NO ACTION ON DELETE NO ACTION;